name: Sync upstream releases

on:
  workflow_dispatch:
  schedule:
    - cron: '30 */6 * * *'

jobs:
  sync-releases:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout control branch
        uses: actions/checkout@v4
        with:
          ref: backup-meta
          fetch-depth: 0

      - name: Download upstream releases (all assets)
        run: |
          mkdir -p releases
          page=1
          while true; do
            data=$(gh api repos/badafans/dns-proxy/releases?page=$page)
            count=$(echo "$data" | jq length)
            [ "$count" -eq 0 ] && break

            echo "$data" | jq -r '.[] | .tag_name' | while read tag; do
              echo "Downloading assets for $tag"
              gh release download "$tag" \
                --repo badafans/dns-proxy \
                --dir "releases/$tag" || true
            done

            page=$((page+1))
          done
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish releases to backup repo
        run: |
          for dir in releases/*; do
            [ -d "$dir" ] || continue
            tag=$(basename "$dir")

            echo "Processing release $tag"

            if gh release view "$tag" --repo "$GITHUB_REPOSITORY" >/dev/null 2>&1; then
              echo "Release exists, uploading assets..."
              gh release upload "$tag" "$dir"/* \
                --repo "$GITHUB_REPOSITORY" \
                --clobber
            else
              echo "Creating new release $tag"
              gh release create "$tag" "$dir"/* \
                --repo "$GITHUB_REPOSITORY" \
                --title "$tag" \
                --notes "Backup from badafans/dns-proxy"
            fi
          done
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
